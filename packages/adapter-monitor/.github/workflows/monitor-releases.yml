name: Monitor CLI Releases

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      adapter:
        description: 'Specific adapter to check (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - claude
          - gemini
          - codex
          - aider

  # Schedule: Check daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'

  # Trigger on release webhook (requires GitHub App setup)
  # repository_dispatch:
  #   types: [cli-release]

jobs:
  check-versions:
    name: Check for CLI Updates
    runs-on: ubuntu-latest

    outputs:
      updates: ${{ steps.check.outputs.updates }}
      has_updates: ${{ steps.check.outputs.has_updates }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: packages/adapter-monitor
        run: npm install

      - name: Load current versions
        id: current
        run: |
          if [ -f packages/adapter-monitor/snapshots/versions.json ]; then
            echo "versions=$(cat packages/adapter-monitor/snapshots/versions.json)" >> $GITHUB_OUTPUT
          else
            echo "versions={}" >> $GITHUB_OUTPUT
          fi

      - name: Check for updates
        id: check
        working-directory: packages/adapter-monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx tsx src/cli.ts check-versions --json > /tmp/version-check.json

          # Extract updates
          UPDATES=$(cat /tmp/version-check.json | jq -c '[.[] | select(.updateAvailable == true)]')
          HAS_UPDATES=$([ "$UPDATES" != "[]" ] && echo "true" || echo "false")

          echo "updates=$UPDATES" >> $GITHUB_OUTPUT
          echo "has_updates=$HAS_UPDATES" >> $GITHUB_OUTPUT

          # Log results
          echo "Version check results:"
          cat /tmp/version-check.json | jq .

  capture-snapshots:
    name: Capture Snapshots
    needs: check-versions
    if: needs.check-versions.outputs.has_updates == 'true'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        update: ${{ fromJson(needs.check-versions.outputs.updates) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: packages/adapter-monitor
        run: npm install

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Capture snapshot for ${{ matrix.update.adapter }}
        working-directory: packages/adapter-monitor
        run: |
          echo "Capturing snapshot for ${{ matrix.update.adapter }} v${{ matrix.update.latestVersion }}"
          npx tsx src/cli.ts capture \
            --adapter ${{ matrix.update.adapter }} \
            --version ${{ matrix.update.latestVersion }} \
            --docker

      - name: Upload snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-${{ matrix.update.adapter }}-${{ matrix.update.latestVersion }}
          path: packages/adapter-monitor/snapshots/${{ matrix.update.adapter }}/
          retention-days: 90

  analyze-and-pr:
    name: Analyze & Create PR
    needs: [check-versions, capture-snapshots]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download all snapshot artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages/adapter-monitor/snapshots/
          pattern: snapshot-*
          merge-multiple: true

      - name: Install dependencies
        working-directory: packages/adapter-monitor
        run: npm install

      - name: Analyze patterns and generate diff
        id: analyze
        working-directory: packages/adapter-monitor
        run: |
          npx tsx src/cli.ts analyze --all --json > /tmp/analysis.json

          # Check if there are pattern changes
          CHANGES=$(cat /tmp/analysis.json | jq -c '[.[] | select(.hasChanges == true)]')
          HAS_CHANGES=$([ "$CHANGES" != "[]" ] && echo "true" || echo "false")

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "changes=$CHANGES" >> $GITHUB_OUTPUT

      - name: Generate PR body
        if: steps.analyze.outputs.has_changes == 'true'
        id: pr-body
        run: |
          cat << 'EOF' > /tmp/pr-body.md
          ## Adapter Pattern Updates

          This PR was automatically generated by the adapter monitor workflow.
          New CLI versions were detected and snapshots were captured.

          ### Changes Detected

          ```json
          ${{ steps.analyze.outputs.changes }}
          ```

          ### Review Checklist

          - [ ] Verify the new ready patterns are correct
          - [ ] Verify auth patterns haven't regressed
          - [ ] Check for any breaking changes
          - [ ] Test with the actual CLI if needed

          ### Snapshots

          Full snapshots are attached as workflow artifacts.
          EOF

      - name: Create Pull Request
        if: steps.analyze.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat(adapters): update patterns for new CLI versions'
          title: 'feat(adapters): Update patterns for new CLI versions'
          body-path: /tmp/pr-body.md
          branch: adapter-pattern-updates
          delete-branch: true
          labels: |
            automated
            adapters
            patterns

  notify:
    name: Notify on Failure
    needs: [check-versions, capture-snapshots, analyze-and-pr]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Adapter Monitor Workflow Failed',
              body: `The adapter monitoring workflow failed. Please investigate.

              Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'automated']
            });
