// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core entities
model Pattern {
  id          String      @id @default(uuid())
  name        String      @unique
  version     String      @default("1.0.0")
  description String
  script      String      @db.Text
  metadata    Json?
  input       Json?
  minAgents   Int?
  maxAgents   Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  executions  Execution[]
  
  @@index([name])
}

model Agent {
  id           String   @id @default(uuid())
  name         String
  endpoint     String
  capabilities Json     @default("[]")
  status       String   @default("unknown")
  expertise    Json?
  metadata     Json?
  lastSeen     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([status])
  @@index([lastSeen])
}

// Time-series data (will be converted to TimescaleDB hypertables)
model Execution {
  id           String   @id @default(uuid())
  time         DateTime @default(now()) @db.Timestamptz
  patternId    String
  pattern      Pattern  @relation(fields: [patternId], references: [id])
  status       String   @default("pending") // pending, running, completed, failed, cancelled
  input        Json
  result       Json?
  error        String?  @db.Text
  confidence   Float?
  metrics      Json?
  warnings     Json?
  durationMs   Int?
  agentCount   Int?
  createdAt    DateTime @default(now())
  
  events       ExecutionEvent[]
  
  @@index([time, patternId])
  @@index([status])
  @@index([time])
}

model ExecutionEvent {
  id          String    @id @default(uuid())
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  time        DateTime  @default(now()) @db.Timestamptz
  type        String    // started, agent_called, agent_responded, completed, failed
  agentId     String?
  data        Json
  
  @@index([executionId, time])
  @@index([time])
}

// For confidence tracking and calibration
model ConfidenceMetric {
  id          String   @id @default(uuid())
  time        DateTime @default(now()) @db.Timestamptz
  agentId     String
  patternId   String?
  task        String?
  predicted   Float    // The confidence score returned by agent
  actual      Float?   // Actual outcome (for calibration)
  metadata    Json?
  
  @@index([time, agentId])
  @@index([time, patternId])
  @@index([time])
}

// For storing pattern versions (future feature)
model PatternVersion {
  id          String   @id @default(uuid())
  patternId   String
  version     String
  script      String   @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())
  createdBy   String?
  
  @@unique([patternId, version])
  @@index([patternId])
}

// For enterprise features (prepared for future)
model License {
  id          String   @id @default(uuid())
  key         String   @unique
  type        String   // opensource, enterprise, enterprise-plus
  validFrom   DateTime
  validUntil  DateTime
  features    Json
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
}

// Session/User management (future)
model Session {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String?
  data        Json?
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}

// Scheduled pattern execution
model Schedule {
  id              String    @id @default(uuid())
  name            String
  patternName     String
  description     String?
  cronExpression  String?   // Cron expression: "0 9 * * *"
  intervalMs      Int?      // Interval in milliseconds
  timezone        String    @default("UTC")
  status          String    @default("active") // active, paused, completed
  input           Json?     // Input to pass to pattern
  nextRunAt       DateTime? @db.Timestamptz
  lastRunAt       DateTime? @db.Timestamptz
  lastRunStatus   String?   // success, failure
  runCount        Int       @default(0)
  maxRuns         Int?      // Optional limit on total runs
  startAt         DateTime? @db.Timestamptz // Delayed start
  endAt           DateTime? @db.Timestamptz // Auto-expire
  retryPolicy     Json?     // Retry configuration
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?

  runs            ScheduleRun[]

  @@index([status])
  @@index([nextRunAt])
  @@index([patternName])
}

// Schedule execution history
model ScheduleRun {
  id           String    @id @default(uuid())
  scheduleId   String
  schedule     Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  executionId  String?   // Links to Execution if pattern was run
  scheduledFor DateTime  @db.Timestamptz
  startedAt    DateTime? @db.Timestamptz
  completedAt  DateTime? @db.Timestamptz
  status       String    @default("pending") // pending, running, success, failure, skipped
  error        String?   @db.Text
  durationMs   Int?

  @@index([scheduleId, scheduledFor])
  @@index([status])
}

// Webhook and event triggers
model Trigger {
  id            String    @id @default(uuid())
  name          String
  type          String    // webhook, event
  patternName   String
  description   String?
  webhookPath   String?   @unique // Unique path for webhook URL
  webhookSecret String?   // Optional secret for webhook validation
  eventType     String?   // Event type to listen for
  eventFilter   Json?     // Filter conditions for events
  inputMapping  Json?     // Transform incoming data to pattern input
  status        String    @default("active") // active, paused
  metadata      Json?
  lastTriggered DateTime? @db.Timestamptz
  triggerCount  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?

  @@index([type, status])
  @@index([webhookPath])
  @@index([eventType])
}

// Audit logging
model AuditLog {
  id          String   @id @default(uuid())
  timestamp   DateTime @default(now()) @db.Timestamptz
  userId      String?
  userEmail   String?
  action      String   // create, update, delete, execute, login, logout
  resource    String   // pattern, schedule, trigger, user, etc.
  resourceId  String?
  ipAddress   String?
  userAgent   String?
  status      String   @default("success") // success, failure
  details     Json?

  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([resource, resourceId])
  @@index([action])
}

// User management
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  passwordHash  String?   // Null for SSO-only users
  role          String    @default("viewer") // admin, operator, developer, viewer
  status        String    @default("active") // active, inactive, pending
  ssoProvider   String?   // google, okta, azure, saml
  ssoSubject    String?   // External ID from SSO provider
  lastLoginAt   DateTime?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  apiKeys       ApiKey[]

  @@index([email])
  @@index([status])
  @@unique([ssoProvider, ssoSubject])
}

// API Keys for programmatic access
model ApiKey {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  keyHash     String    @unique // Hashed API key
  keyPrefix   String    // First 8 chars for identification
  permissions Json?     // Optional permission restrictions
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([keyHash])
  @@index([userId])
}

// Git credential grants for workspace provisioning
model CredentialGrant {
  id            String    @id @default(uuid())
  type          String    // github_app, oauth, deploy_key, pat
  repo          String    // Repository (e.g., owner/repo)
  provider      String    // github, gitlab, bitbucket, azure_devops, self_hosted
  executionId   String    // Execution that requested the credential
  taskId        String?   // Optional task ID
  agentId       String?   // Optional agent ID
  permissions   Json      // Array of permissions granted
  reason        String?   // Reason for credential request
  createdAt     DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  lastUsedAt    DateTime?
  usageCount    Int       @default(0)

  @@index([executionId])
  @@index([repo])
  @@index([createdAt])
  @@index([expiresAt])
}

// Workspace records for git workspace provisioning
model Workspace {
  id            String    @id @default(uuid())
  path          String    // Local path to workspace
  repo          String    // Repository (e.g., owner/repo)
  branchName    String    // Branch name (parallax/{execution-id}/{role}-{slug})
  baseBranch    String    // Base branch (e.g., main)
  executionId   String    // Execution that owns this workspace
  taskId        String?   // Optional task ID
  role          String?   // Role of the agent using this workspace
  status        String    @default("provisioning") // provisioning, ready, in_use, finalizing, cleaned_up, error
  credentialId  String?   // Reference to CredentialGrant
  provisionedAt DateTime  @default(now())
  cleanedUpAt   DateTime?
  prNumber      Int?      // Pull request number if created
  prUrl         String?   // Pull request URL

  @@index([executionId])
  @@index([status])
  @@index([repo])
}