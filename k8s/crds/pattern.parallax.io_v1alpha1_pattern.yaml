apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: patterns.pattern.parallax.io
spec:
  group: pattern.parallax.io
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          apiVersion:
            type: string
          kind:
            type: string
          metadata:
            type: object
          spec:
            type: object
            required:
            - name
            - source
            properties:
              name:
                type: string
                description: Pattern name
              description:
                type: string
                description: Pattern description
              source:
                type: object
                description: Pattern source configuration
                properties:
                  type:
                    type: string
                    enum:
                    - inline
                    - configMap
                    - url
                  content:
                    type: string
                    description: Inline Prism content (when type is inline)
                  configMapRef:
                    type: object
                    description: ConfigMap reference (when type is configMap)
                    properties:
                      name:
                        type: string
                      key:
                        type: string
                  url:
                    type: string
                    description: URL to fetch pattern from (when type is url)
              parameters:
                type: object
                description: Default parameters for the pattern
                additionalProperties:
                  type: string
              requiredCapabilities:
                type: array
                description: Capabilities required by this pattern
                items:
                  type: string
              minAgents:
                type: integer
                description: Minimum number of agents required
                minimum: 1
              confidenceThreshold:
                type: number
                description: Minimum confidence threshold for results
                minimum: 0
                maximum: 1
                default: 0.7
              timeout:
                type: string
                description: Execution timeout
                default: 30s
              retryPolicy:
                type: object
                description: Retry configuration
                properties:
                  maxRetries:
                    type: integer
                    default: 3
                  backoffMultiplier:
                    type: number
                    default: 2
                  initialDelay:
                    type: string
                    default: 1s
          status:
            type: object
            properties:
              phase:
                type: string
                enum:
                - Pending
                - Ready
                - Failed
                - Updating
              lastUpdated:
                type: string
              version:
                type: string
                description: Pattern version hash
              executions:
                type: object
                properties:
                  total:
                    type: integer
                  successful:
                    type: integer
                  failed:
                    type: integer
                  averageConfidence:
                    type: number
                  averageDuration:
                    type: string
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    lastTransitionTime:
                      type: string
                    reason:
                      type: string
                    message:
                      type: string
    additionalPrinterColumns:
    - name: Status
      type: string
      jsonPath: .status.phase
    - name: Executions
      type: integer
      jsonPath: .status.executions.total
    - name: Success Rate
      type: string
      jsonPath: .status.executions.successRate
    - name: Avg Confidence
      type: number
      jsonPath: .status.executions.averageConfidence
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
  scope: Namespaced
  names:
    plural: patterns
    singular: pattern
    kind: Pattern
    shortNames:
    - pxp